{{- if .Values.networkPolicy.enabled }}
---
# NetworkPolicy for Demo App
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: demo-app-netpol
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: demo-app
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from anywhere to the app port
  - from: []
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow connection to IBM MQ
  - to:
    - podSelector:
        matchLabels:
          app: ibmmq
    ports:
    - protocol: TCP
      port: {{ .Values.ibmmq.service.port }}
  # Allow connection to Kafka
  - to:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: {{ .Values.kafka.service.port }}
  # Allow connection to Prometheus (for metrics)
  - to:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
---
# NetworkPolicy for IBM MQ
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ibmmq-netpol
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: ibmmq
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from demo app
  - from:
    - podSelector:
        matchLabels:
          app: demo-app
    ports:
    - protocol: TCP
      port: {{ .Values.ibmmq.service.port }}
  # Allow web console access from anywhere (for NodePort)
  - from: []
    ports:
    - protocol: TCP
      port: {{ .Values.ibmmq.service.webPort }}
  # Allow from other MQ instances (for HA)
  - from:
    - podSelector:
        matchLabels:
          app: ibmmq
    ports:
    - protocol: TCP
      port: {{ .Values.ibmmq.service.port }}
  # Allow from Prometheus (for metrics)
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: {{ .Values.ibmmq.service.webPort }}
  egress:
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to other MQ instances (for HA)
  - to:
    - podSelector:
        matchLabels:
          app: ibmmq
---
# NetworkPolicy for Kafka
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kafka-netpol
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: kafka
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from demo app
  - from:
    - podSelector:
        matchLabels:
          app: demo-app
    ports:
    - protocol: TCP
      port: {{ .Values.kafka.service.port }}
  # Allow from other Kafka brokers (for replication)
  - from:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: {{ .Values.kafka.service.port }}
    - protocol: TCP
      port: 9093
  # Allow from Prometheus (for metrics)
  - from:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: {{ .Values.kafka.service.port }}
  # Allow external access via NodePort
  - from: []
    ports:
    - protocol: TCP
      port: {{ .Values.kafka.service.port }}
  egress:
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to other Kafka brokers
  - to:
    - podSelector:
        matchLabels:
          app: kafka
---
# NetworkPolicy for Prometheus
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-netpol
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: prometheus
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from Grafana
  - from:
    - podSelector:
        matchLabels:
          app: grafana
    ports:
    - protocol: TCP
      port: 9090
  # Allow external access via NodePort
  - from: []
    ports:
    - protocol: TCP
      port: 9090
  egress:
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow scraping all pods
  - to:
    - podSelector: {}
---
# NetworkPolicy for Grafana
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: grafana-netpol
  namespace: {{ .Values.global.namespace }}
spec:
  podSelector:
    matchLabels:
      app: grafana
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow external access via NodePort
  - from: []
    ports:
    - protocol: TCP
      port: 3000
  egress:
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow to Prometheus
  - to:
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090
{{- end }}
